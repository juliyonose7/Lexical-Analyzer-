name: CD Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Download JFlex
        run: |
          curl -sSL -o jflex.jar https://repo1.maven.org/maven2/de/jflex/jflex/1.9.1/jflex-1.9.1.jar

      - name: Generate lexer
        run: |
          java -jar jflex.jar -d ./src ./Lexer.flex

      - name: Compile Java sources
        run: |
          mkdir -p out
          javac -d ./out ./src/*.java

      - name: Build release bundle
        run: |
          mkdir -p release
          cp -r src release/src
          cp Lexer.flex release/
          cp README.md release/
          cp CHANGELOG.md release/
          cp VERSIONING.md release/
          cp ejemplo.txt release/
          cp -r out release/out
          tar -czf lexer-${GITHUB_REF_NAME}.tar.gz release

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            lexer-${{ github.ref_name }}.tar.gz
